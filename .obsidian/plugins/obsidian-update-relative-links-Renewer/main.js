/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var __defProp = Object.defineProperty;
var __getOwnPropDesc = Object.getOwnPropertyDescriptor;
var __getOwnPropNames = Object.getOwnPropertyNames;
var __hasOwnProp = Object.prototype.hasOwnProperty;
var __export = (target, all) => {
  for (var name in all)
    __defProp(target, name, { get: all[name], enumerable: true });
};
var __copyProps = (to, from, except, desc) => {
  if (from && typeof from === "object" || typeof from === "function") {
    for (let key of __getOwnPropNames(from))
      if (!__hasOwnProp.call(to, key) && key !== except)
        __defProp(to, key, { get: () => from[key], enumerable: !(desc = __getOwnPropDesc(from, key)) || desc.enumerable });
  }
  return to;
};
var __toCommonJS = (mod) => __copyProps(__defProp({}, "__esModule", { value: true }), mod);

// main.ts
var main_exports = {};
__export(main_exports, {
  default: () => UpdateRelativeLinksPlugin
});
module.exports = __toCommonJS(main_exports);
var import_obsidian = require("obsidian");

// lib/path.ts
var SEP = "/";
function dirname(path) {
  return stackToPath(pathToStack(path).slice(0, -1));
}
function relative(from, to) {
  if (!from) {
    return to;
  }
  const fromStack = pathToStack(from);
  const toStack = pathToStack(to);
  const firstDiffIdx = fromStack.findIndex((value, idx) => value != toStack[idx]);
  const resultStack = [];
  for (let i = firstDiffIdx; i < fromStack.length - 1; i++) {
    resultStack.push("..");
  }
  for (let i = firstDiffIdx; i < toStack.length; i++) {
    resultStack.push(toStack[i]);
  }
  return stackToPath(resultStack);
}
function pathToStack(path) {
  return path.split(SEP);
}
function stackToPath(stack) {
  return stack.join(SEP);
}

// main.ts
var import_fs = require("fs");
var ConfirmModal = class extends import_obsidian.Modal {
  constructor(app, content, onConfirm) {
    super(app);
    this.content = content;
    this.onConfirm = onConfirm;
  }
  onOpen() {
    const { contentEl } = this;
    contentEl.createEl("h1", { text: "Update Releate Links Plugin" });
    contentEl.createEl("p", { text: this.content });
    new import_obsidian.Setting(contentEl).addButton((btn) => btn.setButtonText("Yes").setCta().onClick(() => {
      this.close();
      this.onConfirm();
    })).addButton((btn) => btn.setButtonText("No").onClick(() => {
      this.close();
    }));
  }
  onClose() {
    this.contentEl.empty();
  }
};
var UpdateRelativeLinksPlugin = class extends import_obsidian.Plugin {
  async onload() {
    const { app } = this;
    const { metadataCache, vault } = app;
    const message = "[Renewer] This command will modify all links in the entire vault (not just the current file) to relative paths, and this action cannot be undone. It is recommended that you back up the vault in advance. Please confirm whether you want to execute the command.";
    this.addCommand({
      id: "update-all-relative-links Renewer",
      name: "Update all relative links Renewer",
      callback() {
        new ConfirmModal(app, message, () => {
          const promises = vault.getMarkdownFiles().map((file) => replace(vault.adapter, file, false));
          Promise.all(promises).then((linkCounts) => {
            const updatedLinkCounts = linkCounts.filter((count) => count > 0);
            const linkCount = updatedLinkCounts.reduce((sum, count) => sum + count, 0);
            const fileCount = updatedLinkCounts.length;
            new import_obsidian.Notice(`Update ${linkCount} links in ${fileCount} file${fileCount > 1 ? "s" : ""}.`);
          }).catch((err) => {
            new import_obsidian.Notice("Update links error, see console.");
            console.error(err);
          });
        }).open();
      }
    });
    this.registerEvent(vault.on("rename", (file, oldPath) => {
      var _a;
      if (!oldPath || !file.path.toLocaleLowerCase().endsWith(".md") || ((_a = file.parent) == null ? void 0 : _a.path) === dirname(oldPath)) {
        return;
      }
      if (file instanceof import_obsidian.TFile) {
        const adapter = app.vault.adapter;
        setTimeout(() => replace(vault.adapter, file, true), 100);
      }
    }));
    async function replace(root, file, notice) {
      var _a, _b;
      const metadata = metadataCache.getFileCache(file);
      const links = [...(_a = metadata == null ? void 0 : metadata.links) != null ? _a : [], ...(_b = metadata == null ? void 0 : metadata.embeds) != null ? _b : []];
      const replacePairs = links.map(({ link, original }) => {
        var _a2;
        const linkPath = link.replace(/#.*$/, "");
        if (!linkPath) {
          return null;
        }
        const linkFile = metadataCache.getFirstLinkpathDest(linkPath, file.path);
        if (!linkFile) {
          return null;
        }
        const newLinkPath = ((_a2 = file.parent) == null ? void 0 : _a2.path) === "/" ? linkFile.path : relative(file.path, linkFile.path);
        if (linkPath === newLinkPath) {
          var bCheck = false;
          const titleIndices = findBracketIndicesOfTitle(original);
          if (titleIndices && 2 < titleIndices.closeIndex - titleIndices.openIndex) {
            const altText = original.substring(titleIndices.openIndex, titleIndices.closeIndex);
            if (altText.includes("/"))
              bCheck = true;
          }
          const linkIndices = findParenthesisIndicesOfURL(original);
          if (linkIndices) {
            const url = original.substring(linkIndices.openIndex, linkIndices.closeIndex);
            if (url.includes(".."))
              bCheck = true;
          }
          if (!bCheck)
            return null;
        }
        const newOriginal = replaceOriginal(root.getBasePath() + "/" + file.path, original, linkPath, newLinkPath);
        if (original === newOriginal) {
          return null;
        }
        return [original, newOriginal];
      }).filter((pair) => pair);
      if (!(replacePairs == null ? void 0 : replacePairs.length)) {
        return 0;
      }
      try {
        const content = await vault.read(file);
        const replacedContent = replacePairs.reduce((tmpContent, pair) => {
          return (pair == null ? void 0 : pair.length) === 2 ? tmpContent.replace(pair[0], pair[1]) : tmpContent;
        }, content);
        await vault.modify(file, replacedContent);
        const msg = `Update ${replacePairs.length} links in ${file.path}.`;
        console.log(msg);
        if (notice) {
          new import_obsidian.Notice(msg);
        }
        return replacePairs.length;
      } catch (e) {
        console.error(e);
        if (notice) {
          new import_obsidian.Notice("Update links error, see console.");
        }
        throw e;
      }
    }
    function findBracketIndicesOfTitle(original) {
      const openIndex = original.indexOf("[");
      if (openIndex === -1)
        return null;
      const closeIndex = original.indexOf("](", openIndex + 1);
      if (closeIndex === -1)
        return null;
      return { openIndex, closeIndex };
    }
    function findParenthesisIndicesOfURL(str) {
      const openIndex = str.indexOf("(");
      if (openIndex === -1)
        return null;
      const closeIndex = str.indexOf(")", openIndex + 1);
      if (closeIndex === -1)
        return null;
      return { openIndex, closeIndex };
    }
    function getFileName(path) {
      const segments = path.split("/");
      return decodeURIComponent(segments.pop() || "");
    }
    function getFullDirectory(path) {
      const parts = path.split("/");
      parts.pop();
      return parts.join("/");
    }
    function getLastDirectory(path) {
      const parts = path.split("/");
      return parts.length >= 2 ? parts[parts.length - 2] : "";
    }
    function ensureDirSync(dirPath) {
      const fs2 = require("fs");
      if (!fs2.existsSync(dirPath)) {
        fs2.mkdirSync(dirPath, { recursive: true });
      }
    }
    async function copyFileAsync(src, dest) {
      try {
        await import_fs.promises.access(src);
        try {
          await import_fs.promises.copyFile(src, dest);
        } catch (copyErr) {
          new import_obsidian.Notice("-2 \uBCF5\uC0AC \uC2E4\uD328");
          console.error(copyErr);
        }
      } catch (err) {
        new import_obsidian.Notice("-1 \uC6D0\uBCF8 \uC5C6\uC74C");
        console.error(err);
      }
    }
    function replaceOriginal(filePath, original, link, newLink) {
      const titleIndices = findBracketIndicesOfTitle(original);
      if (titleIndices && 2 < titleIndices.closeIndex - titleIndices.openIndex) {
        const tmplinkIndices = findParenthesisIndicesOfURL(original);
        if (!tmplinkIndices)
          return null;
        const url = original.substring(tmplinkIndices.openIndex + 1, tmplinkIndices.closeIndex);
        if (url.includes(".md")) {
          const Title = original.substring(titleIndices.openIndex + 1, titleIndices.closeIndex);
          original = original.replace(Title, getFileName(Title));
        } else {
          const Title = original.substring(0, titleIndices.closeIndex);
          if (Title.includes("![")) {
            const Title2 = original.substring(titleIndices.openIndex + 1, titleIndices.closeIndex);
            original = original.replace(Title2, getFileName(link));
          } else {
            original = original.replace(Title, getFileName(link));
          }
        }
      } else {
        original = original.replace("[]", "[" + link + "]");
      }
      const linkIndices = findParenthesisIndicesOfURL(original);
      if (linkIndices) {
        const url = original.substring(linkIndices.openIndex + 1, linkIndices.closeIndex);
        if (url.includes("..") && !url.includes(".md")) {
          const fileDir = getFullDirectory(filePath);
          const newUrlDir = fileDir + "/" + getLastDirectory(link);
          ensureDirSync(newUrlDir);
          copyFileAsync(fileDir + "/" + link, newUrlDir + "/" + getFileName(link));
          newLink = getLastDirectory(link) + "/" + getFileName(link);
        }
        let newOriginal = replaceWithFormat(original, "(" + url + ")", "(" + newLink + ")", (s) => s.replace(/ /g, "%20"));
        if (original === newOriginal) {
          newOriginal = replaceWithFormat(original, "(" + url + ")", "(" + newLink + ")", encodeURI);
        }
        if (original === newOriginal) {
          newOriginal = original.replace(/^(!?\[.*?\]).*$/, `$1(${encodeURI(newLink)})`);
        }
        return newOriginal;
      }
      return null;
    }
    function replaceWithFormat(str, from, to, format) {
      return str.replace(format(from), format(to));
    }
  }
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsibWFpbi50cyIsICJsaWIvcGF0aC50cyJdLAogICJzb3VyY2VzQ29udGVudCI6IFsiaW1wb3J0IHsgQXBwLCBNb2RhbCwgTm90aWNlLCBQbHVnaW4sIFNldHRpbmcsIFRGaWxlLCBGaWxlU3lzdGVtQWRhcHRlciB9IGZyb20gJ29ic2lkaWFuJztcclxuaW1wb3J0IHsgZGlybmFtZSwgcmVsYXRpdmUgfSBmcm9tICcuL2xpYi9wYXRoJztcclxuaW1wb3J0IHsgcHJvbWlzZXMgYXMgZnMgfSBmcm9tICdmcyc7XHJcblxyXG5jbGFzcyBDb25maXJtTW9kYWwgZXh0ZW5kcyBNb2RhbCB7XHJcbiAgICBjb250ZW50OiBzdHJpbmc7XHJcbiAgICBvbkNvbmZpcm06ICgpID0+IHZvaWQ7XHJcblxyXG4gICAgY29uc3RydWN0b3IoYXBwOiBBcHAsIGNvbnRlbnQ6IHN0cmluZywgb25Db25maXJtOiAoKSA9PiB2b2lkKSB7XHJcbiAgICAgICAgc3VwZXIoYXBwKTtcclxuXHJcbiAgICAgICAgdGhpcy5jb250ZW50ID0gY29udGVudDtcclxuICAgICAgICB0aGlzLm9uQ29uZmlybSA9IG9uQ29uZmlybTtcclxuICAgIH1cclxuXHJcbiAgICBvbk9wZW4oKSB7XHJcbiAgICAgICAgY29uc3QgeyBjb250ZW50RWwgfSA9IHRoaXM7XHJcblxyXG4gICAgICAgIGNvbnRlbnRFbC5jcmVhdGVFbCgnaDEnLCB7IHRleHQ6ICdVcGRhdGUgUmVsZWF0ZSBMaW5rcyBQbHVnaW4nIH0pO1xyXG4gICAgICAgIGNvbnRlbnRFbC5jcmVhdGVFbCgncCcsIHsgdGV4dDogdGhpcy5jb250ZW50IH0pO1xyXG5cclxuICAgICAgICBuZXcgU2V0dGluZyhjb250ZW50RWwpXHJcbiAgICAgICAgICAgIC5hZGRCdXR0b24oKGJ0bikgPT4gYnRuXHJcbiAgICAgICAgICAgICAgICAuc2V0QnV0dG9uVGV4dCgnWWVzJylcclxuICAgICAgICAgICAgICAgIC5zZXRDdGEoKVxyXG4gICAgICAgICAgICAgICAgLm9uQ2xpY2soKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY2xvc2UoKTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLm9uQ29uZmlybSgpO1xyXG4gICAgICAgICAgICAgICAgfSkpXHJcbiAgICAgICAgICAgIC5hZGRCdXR0b24oKGJ0bikgPT4gYnRuXHJcbiAgICAgICAgICAgICAgICAuc2V0QnV0dG9uVGV4dCgnTm8nKVxyXG4gICAgICAgICAgICAgICAgLm9uQ2xpY2soKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY2xvc2UoKTtcclxuICAgICAgICAgICAgICAgIH0pKTtcclxuICAgIH1cclxuXHJcbiAgICBvbkNsb3NlKCkge1xyXG4gICAgICAgIHRoaXMuY29udGVudEVsLmVtcHR5KCk7XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFVwZGF0ZVJlbGF0aXZlTGlua3NQbHVnaW4gZXh0ZW5kcyBQbHVnaW4ge1xyXG4gICAgYXN5bmMgb25sb2FkKCkge1xyXG4gICAgICAgIGNvbnN0IHsgYXBwIH0gPSB0aGlzO1xyXG4gICAgICAgIGNvbnN0IHsgbWV0YWRhdGFDYWNoZSwgdmF1bHQgfSA9IGFwcDtcclxuXHJcbiAgICAgICAgY29uc3QgbWVzc2FnZSA9ICdbUmVuZXdlcl0gVGhpcyBjb21tYW5kIHdpbGwgbW9kaWZ5IGFsbCBsaW5rcyBpbiB0aGUgZW50aXJlIHZhdWx0IChub3QganVzdCB0aGUgY3VycmVudCBmaWxlKSB0byByZWxhdGl2ZSBwYXRocywnXHJcbiAgICAgICAgICAgICsgJyBhbmQgdGhpcyBhY3Rpb24gY2Fubm90IGJlIHVuZG9uZS4nXHJcbiAgICAgICAgICAgICsgJyBJdCBpcyByZWNvbW1lbmRlZCB0aGF0IHlvdSBiYWNrIHVwIHRoZSB2YXVsdCBpbiBhZHZhbmNlLidcclxuICAgICAgICAgICAgKyAnIFBsZWFzZSBjb25maXJtIHdoZXRoZXIgeW91IHdhbnQgdG8gZXhlY3V0ZSB0aGUgY29tbWFuZC4nO1xyXG5cclxuICAgICAgICB0aGlzLmFkZENvbW1hbmQoe1xyXG4gICAgICAgICAgICBpZDogJ3VwZGF0ZS1hbGwtcmVsYXRpdmUtbGlua3MgUmVuZXdlcicsXHJcbiAgICAgICAgICAgIG5hbWU6ICdVcGRhdGUgYWxsIHJlbGF0aXZlIGxpbmtzIFJlbmV3ZXInLFxyXG4gICAgICAgICAgICBjYWxsYmFjaygpIHtcclxuICAgICAgICAgICAgICAgIG5ldyBDb25maXJtTW9kYWwoYXBwLCBtZXNzYWdlLCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcHJvbWlzZXMgPSB2YXVsdC5nZXRNYXJrZG93bkZpbGVzKCkubWFwKGZpbGUgPT4gcmVwbGFjZSh2YXVsdC5hZGFwdGVyIGFzIEZpbGVTeXN0ZW1BZGFwdGVyLCBmaWxlLCBmYWxzZSkpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBQcm9taXNlLmFsbChwcm9taXNlcykudGhlbihsaW5rQ291bnRzID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdXBkYXRlZExpbmtDb3VudHMgPSBsaW5rQ291bnRzLmZpbHRlcihjb3VudCA9PiBjb3VudCA+IDApO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbGlua0NvdW50ID0gdXBkYXRlZExpbmtDb3VudHMucmVkdWNlKChzdW0sIGNvdW50KSA9PiBzdW0gKyBjb3VudCwgMCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGZpbGVDb3VudCA9IHVwZGF0ZWRMaW5rQ291bnRzLmxlbmd0aDtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ldyBOb3RpY2UoYFVwZGF0ZSAke2xpbmtDb3VudH0gbGlua3MgaW4gJHtmaWxlQ291bnR9IGZpbGUke2ZpbGVDb3VudCA+IDEgPyAncycgOiAnJ30uYCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSkuY2F0Y2goZXJyID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbmV3IE5vdGljZSgnVXBkYXRlIGxpbmtzIGVycm9yLCBzZWUgY29uc29sZS4nKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnIpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfSkub3BlbigpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHRoaXMucmVnaXN0ZXJFdmVudCh2YXVsdC5vbigncmVuYW1lJywgKGZpbGUsIG9sZFBhdGgpID0+IHtcclxuICAgICAgICAgICAgaWYgKCFvbGRQYXRoXHJcbiAgICAgICAgICAgICAgICB8fCAhZmlsZS5wYXRoLnRvTG9jYWxlTG93ZXJDYXNlKCkuZW5kc1dpdGgoJy5tZCcpXHJcbiAgICAgICAgICAgICAgICB8fCBmaWxlLnBhcmVudD8ucGF0aCA9PT0gZGlybmFtZShvbGRQYXRoKSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAoZmlsZSBpbnN0YW5jZW9mIFRGaWxlKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBhZGFwdGVyID0gYXBwLnZhdWx0LmFkYXB0ZXI7XHJcbiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHJlcGxhY2UodmF1bHQuYWRhcHRlciBhcyBGaWxlU3lzdGVtQWRhcHRlciwgZmlsZSwgdHJ1ZSksIDEwMCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KSk7XHJcblxyXG4gICAgICAgIGFzeW5jIGZ1bmN0aW9uIHJlcGxhY2Uocm9vdDogRmlsZVN5c3RlbUFkYXB0ZXIsIGZpbGU6IFRGaWxlLCBub3RpY2U6IGJvb2xlYW4pIHtcclxuICAgICAgICAgICAgY29uc3QgbWV0YWRhdGEgPSBtZXRhZGF0YUNhY2hlLmdldEZpbGVDYWNoZShmaWxlKTtcclxuICAgICAgICAgICAgY29uc3QgbGlua3MgPSBbLi4uKG1ldGFkYXRhPy5saW5rcyA/PyBbXSksIC4uLihtZXRhZGF0YT8uZW1iZWRzID8/IFtdKV07XHJcbiAgICAgICAgICAgIGNvbnN0IHJlcGxhY2VQYWlycyA9IGxpbmtzLm1hcCgoeyBsaW5rLCBvcmlnaW5hbCB9KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAvL2lmICghb3JpZ2luYWwuc3RhcnRzV2l0aCgnIVsnKSkgcmV0dXJuIG51bGw7XHJcblxyXG4gICAgICAgICAgICAgICAgY29uc3QgbGlua1BhdGggPSBsaW5rLnJlcGxhY2UoLyMuKiQvLCAnJyk7XHJcbiAgICAgICAgICAgICAgICBpZiAoIWxpbmtQYXRoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgY29uc3QgbGlua0ZpbGUgPSBtZXRhZGF0YUNhY2hlLmdldEZpcnN0TGlua3BhdGhEZXN0KGxpbmtQYXRoLCBmaWxlLnBhdGgpO1xyXG4gICAgICAgICAgICAgICAgaWYgKCFsaW5rRmlsZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGNvbnN0IG5ld0xpbmtQYXRoID0gZmlsZS5wYXJlbnQ/LnBhdGggPT09ICcvJyA/IGxpbmtGaWxlLnBhdGggOiByZWxhdGl2ZShmaWxlLnBhdGgsIGxpbmtGaWxlLnBhdGgpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGxpbmtQYXRoID09PSBuZXdMaW5rUGF0aCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBiQ2hlY2sgPSBmYWxzZTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdGl0bGVJbmRpY2VzID0gZmluZEJyYWNrZXRJbmRpY2VzT2ZUaXRsZShvcmlnaW5hbClcclxuICAgICAgICAgICAgICAgICAgICBpZih0aXRsZUluZGljZXMgJiYgMiA8ICh0aXRsZUluZGljZXMuY2xvc2VJbmRleCAtIHRpdGxlSW5kaWNlcy5vcGVuSW5kZXgpKVxyXG4gICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYWx0VGV4dCA9IG9yaWdpbmFsLnN1YnN0cmluZyh0aXRsZUluZGljZXMub3BlbkluZGV4ICwgdGl0bGVJbmRpY2VzLmNsb3NlSW5kZXgpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKGFsdFRleHQuaW5jbHVkZXMoJy8nKSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJDaGVjayA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBsaW5rSW5kaWNlcyA9IGZpbmRQYXJlbnRoZXNpc0luZGljZXNPZlVSTChvcmlnaW5hbClcclxuICAgICAgICAgICAgICAgICAgICBpZihsaW5rSW5kaWNlcylcclxuICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHVybCA9IG9yaWdpbmFsLnN1YnN0cmluZyhsaW5rSW5kaWNlcy5vcGVuSW5kZXggLCBsaW5rSW5kaWNlcy5jbG9zZUluZGV4KVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZih1cmwuaW5jbHVkZXMoJy4uJykpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiQ2hlY2sgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYoIWJDaGVjaylcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBjb25zdCBuZXdPcmlnaW5hbCA9IHJlcGxhY2VPcmlnaW5hbChyb290LmdldEJhc2VQYXRoKCkgKyBcIi9cIiArIGZpbGUucGF0aCwgb3JpZ2luYWwsIGxpbmtQYXRoLCBuZXdMaW5rUGF0aCk7XHJcbiAgICAgICAgICAgICAgICAvL25ldyBOb3RpY2UoZmlsZS5uYW1lICsgJ1xcbi0gb3JpZ2luYWw6ICcgKyBvcmlnaW5hbCArICdcXG4tIG5ld09yaWdpbmFsOiAnICsgbmV3T3JpZ2luYWwpO1xyXG4gICAgICAgICAgICAgICAgaWYgKG9yaWdpbmFsID09PSBuZXdPcmlnaW5hbCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIFtvcmlnaW5hbCwgbmV3T3JpZ2luYWxdO1xyXG4gICAgICAgICAgICB9KS5maWx0ZXIocGFpciA9PiBwYWlyKTtcclxuXHJcbiAgICAgICAgICAgIGlmICghcmVwbGFjZVBhaXJzPy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiAwO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgY29udGVudCA9IGF3YWl0IHZhdWx0LnJlYWQoZmlsZSk7XHJcblxyXG4gICAgICAgICAgICAgICAgY29uc3QgcmVwbGFjZWRDb250ZW50ID0gcmVwbGFjZVBhaXJzLnJlZHVjZSgodG1wQ29udGVudCwgcGFpcikgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBwYWlyPy5sZW5ndGggPT09IDIgXHJcbiAgICAgICAgICAgICAgICAgICAgPyB0bXBDb250ZW50LnJlcGxhY2UocGFpclswXSwgcGFpclsxXSkgXHJcbiAgICAgICAgICAgICAgICAgICAgOiB0bXBDb250ZW50O1xyXG4gICAgICAgICAgICAgICAgfSwgY29udGVudCk7XHJcblxyXG4gICAgICAgICAgICAgICAgYXdhaXQgdmF1bHQubW9kaWZ5KGZpbGUsIHJlcGxhY2VkQ29udGVudCk7XHJcblxyXG4gICAgICAgICAgICAgICAgY29uc3QgbXNnID0gYFVwZGF0ZSAke3JlcGxhY2VQYWlycy5sZW5ndGh9IGxpbmtzIGluICR7ZmlsZS5wYXRofS5gO1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2cobXNnKTtcclxuICAgICAgICAgICAgICAgIGlmIChub3RpY2UpIHtcclxuICAgICAgICAgICAgICAgICAgICBuZXcgTm90aWNlKG1zZyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVwbGFjZVBhaXJzLmxlbmd0aDtcclxuICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlKTtcclxuICAgICAgICAgICAgICAgIGlmIChub3RpY2UpIHtcclxuICAgICAgICAgICAgICAgICAgICBuZXcgTm90aWNlKCdVcGRhdGUgbGlua3MgZXJyb3IsIHNlZSBjb25zb2xlLicpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgdGhyb3cgZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgZnVuY3Rpb24gZmluZEJyYWNrZXRJbmRpY2VzT2ZUaXRsZShvcmlnaW5hbDogc3RyaW5nKTogeyBvcGVuSW5kZXg6IG51bWJlcjsgY2xvc2VJbmRleDogbnVtYmVyIH0gfCBudWxsIHtcclxuICAgICAgICAgICAgY29uc3Qgb3BlbkluZGV4ID0gb3JpZ2luYWwuaW5kZXhPZignWycpXHJcbiAgICAgICAgICAgIGlmIChvcGVuSW5kZXggPT09IC0xKSByZXR1cm4gbnVsbFxyXG4gICAgICAgICAgICBjb25zdCBjbG9zZUluZGV4ID0gb3JpZ2luYWwuaW5kZXhPZignXSgnLCBvcGVuSW5kZXggKyAxKVxyXG4gICAgICAgICAgICBpZiAoY2xvc2VJbmRleCA9PT0gLTEpIHJldHVybiBudWxsXHJcbiAgICAgICAgICAgIHJldHVybiB7IG9wZW5JbmRleCwgY2xvc2VJbmRleCB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBmdW5jdGlvbiBmaW5kUGFyZW50aGVzaXNJbmRpY2VzT2ZVUkwoc3RyOiBzdHJpbmcpOiB7IG9wZW5JbmRleDogbnVtYmVyOyBjbG9zZUluZGV4OiBudW1iZXIgfSB8IG51bGwge1xyXG4gICAgICAgICAgICBjb25zdCBvcGVuSW5kZXggPSBzdHIuaW5kZXhPZignKCcpXHJcbiAgICAgICAgICAgIGlmIChvcGVuSW5kZXggPT09IC0xKSByZXR1cm4gbnVsbFxyXG4gICAgICAgICAgICBjb25zdCBjbG9zZUluZGV4ID0gc3RyLmluZGV4T2YoJyknLCBvcGVuSW5kZXggKyAxKVxyXG4gICAgICAgICAgICBpZiAoY2xvc2VJbmRleCA9PT0gLTEpIHJldHVybiBudWxsXHJcbiAgICAgICAgICAgIHJldHVybiB7IG9wZW5JbmRleCwgY2xvc2VJbmRleCB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBmdW5jdGlvbiBnZXRGaWxlTmFtZShwYXRoOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgICAgICAgICBjb25zdCBzZWdtZW50cyA9IHBhdGguc3BsaXQoJy8nKTtcclxuICAgICAgICAgICAgcmV0dXJuIGRlY29kZVVSSUNvbXBvbmVudChzZWdtZW50cy5wb3AoKSB8fCAnJyk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBmdW5jdGlvbiBnZXRGdWxsRGlyZWN0b3J5KHBhdGg6IHN0cmluZykge1xyXG4gICAgICAgICAgICBjb25zdCBwYXJ0cyA9IHBhdGguc3BsaXQoJy8nKTtcclxuICAgICAgICAgICAgcGFydHMucG9wKCk7ICAgICAgICAgICAgICAgIC8vIFx1QjlDOFx1QzlDMFx1QjlDOSBcdUM2OTRcdUMxOEMoXHVEMzBDXHVDNzdDXHVCQTg1KSBcdUM4MUNcdUFDNzBcclxuICAgICAgICAgICAgcmV0dXJuIHBhcnRzLmpvaW4oJy8nKTsgICAgIC8vIFx1QjA5OFx1QkEzOFx1QzlDMCBcdUM2OTRcdUMxOENcdUI5N0MgJy8nXHVCODVDIFx1QUNCMFx1RDU2OVxyXG4gICAgICAgIH1cclxuICAgICAgICBmdW5jdGlvbiBnZXRMYXN0RGlyZWN0b3J5KHBhdGg6IHN0cmluZykge1xyXG4gICAgICAgICAgICBjb25zdCBwYXJ0cyA9IHBhdGguc3BsaXQoJy8nKTtcclxuICAgICAgICAgICAgLy8gXHVEMzBDXHVDNzdDXHVCQTg1XHVDNzc0IFx1QzU0NFx1QjJDQyBcdUI5QzhcdUM5QzBcdUI5QzkgXHVEM0Y0XHVCMzU0IFx1Qzc3OFx1QjM3MVx1QzJBNFx1QjI5NCBsZW5ndGgtMlxyXG4gICAgICAgICAgICByZXR1cm4gcGFydHMubGVuZ3RoID49IDIgPyBwYXJ0c1twYXJ0cy5sZW5ndGggLSAyXSA6ICcnO1xyXG4gICAgICAgIH1cclxuICAgICAgICBmdW5jdGlvbiBlbnN1cmVEaXJTeW5jKGRpclBhdGg6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgICAgICAgICAvL25ldyBOb3RpY2UoJ2Vuc3VyZURpclN5bmM6ICcgKyBkaXJQYXRoKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGNvbnN0IGZzID0gcmVxdWlyZSgnZnMnKTtcclxuICAgICAgICAgICAgaWYgKCFmcy5leGlzdHNTeW5jKGRpclBhdGgpKSB7XHJcbiAgICAgICAgICAgICAgICAvL25ldyBOb3RpY2UoJ1x1QzBERFx1QzEzMVx1RDU2OVx1QjJDOFx1QjJFNC4nKTtcclxuICAgICAgICAgICAgICAgIGZzLm1rZGlyU3luYyhkaXJQYXRoLCB7IHJlY3Vyc2l2ZTogdHJ1ZSB9KTtcclxuICAgICAgICAgICAgICAgIC8vbmV3IE5vdGljZSgnXHVDMEREXHVDMTMxIFx1QzY0NFx1QjhDQy4nKTtcclxuICAgICAgICAgICAgICAgIC8vaWYgKGZzLmV4aXN0c1N5bmMoZGlyUGF0aCkpIHtcclxuICAgICAgICAgICAgICAgIC8vICAgIG5ldyBOb3RpY2UoJ1x1Qzg3NFx1QzdBQ1x1RDU2OVx1QjJDOFx1QjJFNCcpO1xyXG4gICAgICAgICAgICAgICAgLy99XHJcbiAgICAgICAgICAgICAgICAvL2Vsc2V7XHJcbiAgICAgICAgICAgICAgICAvLyAgICBuZXcgTm90aWNlKCdcdUMwRERcdUMxMzEgXHVDMkU0XHVEMzI4LicpO1xyXG4gICAgICAgICAgICAgICAgLy99XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgLy9lbHNle1xyXG4gICAgICAgICAgICAvLyAgICBuZXcgTm90aWNlKCdcdUM4NzRcdUM3QUNcdUQ1NjlcdUIyQzhcdUIyRTQuJyk7XHJcbiAgICAgICAgICAgIC8vfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgYXN5bmMgZnVuY3Rpb24gY29weUZpbGVBc3luYyhzcmM6IHN0cmluZywgZGVzdDogc3RyaW5nKSB7XHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICBhd2FpdCBmcy5hY2Nlc3Moc3JjKTsgIC8vIFx1QzZEMFx1QkNGOCBcdUQzMENcdUM3N0MgXHVDODExXHVBREZDIFx1RDY1NVx1Qzc3OFxyXG4gICAgICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgICAgICBhd2FpdCBmcy5jb3B5RmlsZShzcmMsIGRlc3QpOyAgLy8gXHUyNzA1IFx1QzYyQ1x1QkMxNFx1Qjk3OCBcdUJDRjVcdUMwQUMgXHVCQzI5XHVDMkREXHJcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChjb3B5RXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbmV3IE5vdGljZSgnLTIgXHVCQ0Y1XHVDMEFDIFx1QzJFNFx1RDMyOCcpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoY29weUVycik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgXHJcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICAgICAgICAgICAgbmV3IE5vdGljZSgnLTEgXHVDNkQwXHVCQ0Y4IFx1QzVDNlx1Qzc0QycpO1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnIpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBmdW5jdGlvbiByZXBsYWNlT3JpZ2luYWwoZmlsZVBhdGg6IHN0cmluZywgb3JpZ2luYWw6IHN0cmluZywgbGluazogc3RyaW5nLCBuZXdMaW5rOiBzdHJpbmcpIHtcclxuICAgICAgICAgICAgLy9uZXcgTm90aWNlKCdvcmlnaW5hbDogJyArIG9yaWdpbmFsKTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IHRpdGxlSW5kaWNlcyA9IGZpbmRCcmFja2V0SW5kaWNlc09mVGl0bGUob3JpZ2luYWwpXHJcbiAgICAgICAgICAgIGlmKHRpdGxlSW5kaWNlcyAmJiAyIDwgKHRpdGxlSW5kaWNlcy5jbG9zZUluZGV4IC0gdGl0bGVJbmRpY2VzLm9wZW5JbmRleCkpXHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHRtcGxpbmtJbmRpY2VzID0gZmluZFBhcmVudGhlc2lzSW5kaWNlc09mVVJMKG9yaWdpbmFsKVxyXG4gICAgICAgICAgICAgICAgaWYoIXRtcGxpbmtJbmRpY2VzKVxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG5cclxuICAgICAgICAgICAgICAgIGNvbnN0IHVybCA9IG9yaWdpbmFsLnN1YnN0cmluZyh0bXBsaW5rSW5kaWNlcy5vcGVuSW5kZXggKyAxLCB0bXBsaW5rSW5kaWNlcy5jbG9zZUluZGV4KVxyXG4gICAgICAgICAgICAgICAgaWYodXJsLmluY2x1ZGVzKCcubWQnKSl7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgVGl0bGUgPSBvcmlnaW5hbC5zdWJzdHJpbmcodGl0bGVJbmRpY2VzLm9wZW5JbmRleCArIDEgLCB0aXRsZUluZGljZXMuY2xvc2VJbmRleClcclxuICAgICAgICAgICAgICAgICAgICAvL25ldyBOb3RpY2UoJ1RpdGxlMTogJyArIFRpdGxlKTtcclxuICAgICAgICAgICAgICAgICAgICBvcmlnaW5hbCA9IG9yaWdpbmFsLnJlcGxhY2UoVGl0bGUsIGdldEZpbGVOYW1lKFRpdGxlKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgLy9uZXcgTm90aWNlKCdUaXRsZTEgUmVzdWx0OiAnICsgb3JpZ2luYWwpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzZXtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBUaXRsZSA9IG9yaWdpbmFsLnN1YnN0cmluZygwICwgdGl0bGVJbmRpY2VzLmNsb3NlSW5kZXgpXHJcbiAgICAgICAgICAgICAgICAgICAgaWYoVGl0bGUuaW5jbHVkZXMoXCIhW1wiKSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IFRpdGxlID0gb3JpZ2luYWwuc3Vic3RyaW5nKHRpdGxlSW5kaWNlcy5vcGVuSW5kZXggKyAxICwgdGl0bGVJbmRpY2VzLmNsb3NlSW5kZXgpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vbmV3IE5vdGljZSgnVGl0bGUxOiAnICsgVGl0bGUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBvcmlnaW5hbCA9IG9yaWdpbmFsLnJlcGxhY2UoVGl0bGUsIGdldEZpbGVOYW1lKGxpbmspKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy9uZXcgTm90aWNlKCdUaXRsZTEgUmVzdWx0OiAnICsgb3JpZ2luYWwpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBlbHNle1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvL25ldyBOb3RpY2UoJ1RpdGxlMjogJyArIFRpdGxlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgb3JpZ2luYWwgPSBvcmlnaW5hbC5yZXBsYWNlKFRpdGxlLCBnZXRGaWxlTmFtZShsaW5rKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vbmV3IE5vdGljZSgnVGl0bGUyIFJlc3VsdDogJyArIG9yaWdpbmFsKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZVxyXG4gICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAvL25ldyBOb3RpY2UoJ1RpdGxlMzogJyArIG9yaWdpbmFsKTtcclxuICAgICAgICAgICAgICAgIG9yaWdpbmFsID0gb3JpZ2luYWwucmVwbGFjZShcIltdXCIsIFwiW1wiK2xpbmsrXCJdXCIpO1xyXG4gICAgICAgICAgICAgICAgLy9uZXcgTm90aWNlKCdUaXRsZTMgUmVzdWx0OiAnICsgb3JpZ2luYWwpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBjb25zdCBsaW5rSW5kaWNlcyA9IGZpbmRQYXJlbnRoZXNpc0luZGljZXNPZlVSTChvcmlnaW5hbClcclxuICAgICAgICAgICAgaWYobGlua0luZGljZXMpXHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHVybCA9IG9yaWdpbmFsLnN1YnN0cmluZyhsaW5rSW5kaWNlcy5vcGVuSW5kZXggKyAxLCBsaW5rSW5kaWNlcy5jbG9zZUluZGV4KVxyXG4gICAgICAgICAgICAgICAgaWYodXJsLmluY2x1ZGVzKCcuLicpICYmICF1cmwuaW5jbHVkZXMoJy5tZCcpKVxyXG4gICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGZpbGVEaXIgPSBnZXRGdWxsRGlyZWN0b3J5KGZpbGVQYXRoKTtcclxuICAgICAgICAgICAgICAgICAgICAvL25ldyBOb3RpY2UoJ2ZpbGVEaXI6ICcgKyBmaWxlRGlyKTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBuZXdVcmxEaXIgPSBmaWxlRGlyICsgXCIvXCIgKyBnZXRMYXN0RGlyZWN0b3J5KGxpbmspO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vbmV3IE5vdGljZSgnbmV3VXJsRGlyOiAnICsgbmV3VXJsRGlyKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgZW5zdXJlRGlyU3luYyhuZXdVcmxEaXIpXHJcbiAgICAgICAgICAgICAgICAgICAgY29weUZpbGVBc3luYyhmaWxlRGlyK1wiL1wiK2xpbmssIG5ld1VybERpcitcIi9cIitnZXRGaWxlTmFtZShsaW5rKSlcclxuICAgICAgICAgICAgICAgICAgICBuZXdMaW5rID0gZ2V0TGFzdERpcmVjdG9yeShsaW5rKSArIFwiL1wiICsgZ2V0RmlsZU5hbWUobGluayk7XHJcbiAgICAgICAgICAgICAgICAgICAgLy9uZXcgTm90aWNlKCdyZXBsYWNlT3JpZ2luYWwnKTtcclxuICAgICAgICAgICAgICAgICAgICAvL25ldyBOb3RpY2UoJ2ZpbGVEaXI6ICcgKyBmaWxlRGlyKTtcclxuICAgICAgICAgICAgICAgICAgICAvL25ldyBOb3RpY2UoJ2ZpbGVQYXRoOiAnICsgZmlsZVBhdGgpO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vbmV3IE5vdGljZSgnb3JpZ2luYWw6ICcgKyBvcmlnaW5hbCk7XHJcbiAgICAgICAgICAgICAgICAgICAgLy9uZXcgTm90aWNlKCdsaW5rOiAnICsgbGluayk7XHJcbiAgICAgICAgICAgICAgICAgICAgLy9uZXcgTm90aWNlKCduZXdMaW5rOiAnICsgbmV3TGluayk7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgbGV0IG5ld09yaWdpbmFsID0gcmVwbGFjZVdpdGhGb3JtYXQob3JpZ2luYWwsIFwiKFwiK3VybCtcIilcIiwgXCIoXCIrbmV3TGluaytcIilcIiwgcyA9PiBzLnJlcGxhY2UoLyAvZywgJyUyMCcpKTtcclxuICAgICAgICAgICAgICAgIGlmIChvcmlnaW5hbCA9PT0gbmV3T3JpZ2luYWwpIHtcclxuICAgICAgICAgICAgICAgICAgICBuZXdPcmlnaW5hbCA9IHJlcGxhY2VXaXRoRm9ybWF0KG9yaWdpbmFsLCBcIihcIit1cmwrXCIpXCIsIFwiKFwiK25ld0xpbmsrXCIpXCIsIGVuY29kZVVSSSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAob3JpZ2luYWwgPT09IG5ld09yaWdpbmFsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbmV3T3JpZ2luYWwgPSBvcmlnaW5hbC5yZXBsYWNlKC9eKCE/XFxbLio/XFxdKS4qJC8sIGAkMSgke2VuY29kZVVSSShuZXdMaW5rKX0pYClcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIC8vbmV3IE5vdGljZSgnbmV3T3JpZ2luYWw6ICcgKyBuZXdPcmlnaW5hbCk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbmV3T3JpZ2luYWw7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBmdW5jdGlvbiByZXBsYWNlV2l0aEZvcm1hdChzdHI6IHN0cmluZywgZnJvbTogc3RyaW5nLCB0bzogc3RyaW5nLCBmb3JtYXQ6IChzOiBzdHJpbmcpID0+IHN0cmluZykge1xyXG4gICAgICAgICAgICByZXR1cm4gc3RyLnJlcGxhY2UoZm9ybWF0KGZyb20pLCBmb3JtYXQodG8pKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuIiwgImNvbnN0IFNFUCA9ICcvJztcclxuXHJcbmZ1bmN0aW9uIGRpcm5hbWUocGF0aDogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgIHJldHVybiBzdGFja1RvUGF0aChwYXRoVG9TdGFjayhwYXRoKS5zbGljZSgwLCAtMSkpO1xyXG59XHJcblxyXG5mdW5jdGlvbiByZWxhdGl2ZShmcm9tOiBzdHJpbmcsIHRvOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgaWYgKCFmcm9tKSB7XHJcbiAgICAgICAgcmV0dXJuIHRvO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGZyb21TdGFjayA9IHBhdGhUb1N0YWNrKGZyb20pO1xyXG4gICAgY29uc3QgdG9TdGFjayA9IHBhdGhUb1N0YWNrKHRvKTtcclxuXHJcbiAgICBjb25zdCBmaXJzdERpZmZJZHggPSBmcm9tU3RhY2suZmluZEluZGV4KCh2YWx1ZSwgaWR4KSA9PiB2YWx1ZSAhPSB0b1N0YWNrW2lkeF0pO1xyXG5cclxuICAgIGNvbnN0IHJlc3VsdFN0YWNrOiBzdHJpbmdbXSA9IFtdO1xyXG5cclxuICAgIGZvciAobGV0IGkgPSBmaXJzdERpZmZJZHg7IGkgPCBmcm9tU3RhY2subGVuZ3RoIC0gMTsgaSsrKSB7XHJcbiAgICAgICAgcmVzdWx0U3RhY2sucHVzaCgnLi4nKTtcclxuICAgIH1cclxuXHJcbiAgICBmb3IgKGxldCBpID0gZmlyc3REaWZmSWR4OyBpIDwgdG9TdGFjay5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgIHJlc3VsdFN0YWNrLnB1c2godG9TdGFja1tpXSk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHN0YWNrVG9QYXRoKHJlc3VsdFN0YWNrKTtcclxufVxyXG5cclxuZnVuY3Rpb24gcGF0aFRvU3RhY2socGF0aDogc3RyaW5nKTogc3RyaW5nW10ge1xyXG4gICAgcmV0dXJuIHBhdGguc3BsaXQoU0VQKTtcclxufVxyXG5cclxuZnVuY3Rpb24gc3RhY2tUb1BhdGgoc3RhY2s6IHN0cmluZ1tdKTogc3RyaW5nIHtcclxuICAgIHJldHVybiBzdGFjay5qb2luKFNFUCk7XHJcbn1cclxuXHJcbmV4cG9ydCB7IGRpcm5hbWUsIHJlbGF0aXZlIH1cclxuIl0sCiAgIm1hcHBpbmdzIjogIjs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBLHNCQUE4RTs7O0FDQTlFLElBQU0sTUFBTTtBQUVaLFNBQVMsUUFBUSxNQUFzQjtBQUNuQyxTQUFPLFlBQVksWUFBWSxJQUFJLEVBQUUsTUFBTSxHQUFHLEVBQUUsQ0FBQztBQUNyRDtBQUVBLFNBQVMsU0FBUyxNQUFjLElBQW9CO0FBQ2hELE1BQUksQ0FBQyxNQUFNO0FBQ1AsV0FBTztBQUFBLEVBQ1g7QUFFQSxRQUFNLFlBQVksWUFBWSxJQUFJO0FBQ2xDLFFBQU0sVUFBVSxZQUFZLEVBQUU7QUFFOUIsUUFBTSxlQUFlLFVBQVUsVUFB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

/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var __defProp = Object.defineProperty;
var __getOwnPropDesc = Object.getOwnPropertyDescriptor;
var __getOwnPropNames = Object.getOwnPropertyNames;
var __hasOwnProp = Object.prototype.hasOwnProperty;
var __export = (target, all) => {
  for (var name in all)
    __defProp(target, name, { get: all[name], enumerable: true });
};
var __copyProps = (to, from, except, desc) => {
  if (from && typeof from === "object" || typeof from === "function") {
    for (let key of __getOwnPropNames(from))
      if (!__hasOwnProp.call(to, key) && key !== except)
        __defProp(to, key, { get: () => from[key], enumerable: !(desc = __getOwnPropDesc(from, key)) || desc.enumerable });
  }
  return to;
};
var __toCommonJS = (mod) => __copyProps(__defProp({}, "__esModule", { value: true }), mod);

// main.ts
var main_exports = {};
__export(main_exports, {
  default: () => UpdateRelativeLinksPlugin
});
module.exports = __toCommonJS(main_exports);
var import_obsidian = require("obsidian");

// lib/path.ts
var SEP = "/";
function dirname(path) {
  return stackToPath(pathToStack(path).slice(0, -1));
}
function relative(from, to) {
  if (!from) {
    return to;
  }
  const fromStack = pathToStack(from);
  const toStack = pathToStack(to);
  const firstDiffIdx = fromStack.findIndex((value, idx) => value != toStack[idx]);
  const resultStack = [];
  for (let i = firstDiffIdx; i < fromStack.length - 1; i++) {
    resultStack.push("..");
  }
  for (let i = firstDiffIdx; i < toStack.length; i++) {
    resultStack.push(toStack[i]);
  }
  return stackToPath(resultStack);
}
function pathToStack(path) {
  return path.split(SEP);
}
function stackToPath(stack) {
  return stack.join(SEP);
}

// main.ts
var import_fs = require("fs");
var ConfirmModal = class extends import_obsidian.Modal {
  constructor(app, content, onConfirm) {
    super(app);
    this.content = content;
    this.onConfirm = onConfirm;
  }
  onOpen() {
    const { contentEl } = this;
    contentEl.createEl("h1", { text: "Update Releate Links Plugin" });
    contentEl.createEl("p", { text: this.content });
    new import_obsidian.Setting(contentEl).addButton((btn) => btn.setButtonText("Yes").setCta().onClick(() => {
      this.close();
      this.onConfirm();
    })).addButton((btn) => btn.setButtonText("No").onClick(() => {
      this.close();
    }));
  }
  onClose() {
    this.contentEl.empty();
  }
};
var UpdateRelativeLinksPlugin = class extends import_obsidian.Plugin {
  async onload() {
    const { app } = this;
    const { metadataCache, vault } = app;
    const message = "[Renewer] This command will modify all links in the entire vault (not just the current file) to relative paths, and this action cannot be undone. It is recommended that you back up the vault in advance. Please confirm whether you want to execute the command.";
    this.addCommand({
      id: "update-all-relative-links Renewer",
      name: "Update all relative links Renewer",
      callback() {
        new ConfirmModal(app, message, () => {
          const promises = vault.getMarkdownFiles().map((file) => replace(vault.adapter, file, false));
          Promise.all(promises).then((linkCounts) => {
            const updatedLinkCounts = linkCounts.filter((count) => count > 0);
            const linkCount = updatedLinkCounts.reduce((sum, count) => sum + count, 0);
            const fileCount = updatedLinkCounts.length;
            new import_obsidian.Notice(`Update ${linkCount} links in ${fileCount} file${fileCount > 1 ? "s" : ""}.`);
          }).catch((err) => {
            new import_obsidian.Notice("Update links error, see console.");
            console.error(err);
          });
        }).open();
      }
    });
    this.registerEvent(vault.on("rename", (file, oldPath) => {
      var _a;
      if (!oldPath || !file.path.toLocaleLowerCase().endsWith(".md") || ((_a = file.parent) == null ? void 0 : _a.path) === dirname(oldPath)) {
        return;
      }
      if (file instanceof import_obsidian.TFile) {
        const adapter = app.vault.adapter;
        setTimeout(() => replace(vault.adapter, file, true), 100);
      }
    }));
    async function replace(root, file, notice) {
      var _a, _b;
      const metadata = metadataCache.getFileCache(file);
      const links = [...(_a = metadata == null ? void 0 : metadata.links) != null ? _a : [], ...(_b = metadata == null ? void 0 : metadata.embeds) != null ? _b : []];
      const replacePairs = links.map(({ link, original }) => {
        var _a2;
        const linkPath = link.replace(/#.*$/, "");
        if (!linkPath) {
          return null;
        }
        const linkFile = metadataCache.getFirstLinkpathDest(linkPath, file.path);
        if (!linkFile) {
          return null;
        }
        const newLinkPath = ((_a2 = file.parent) == null ? void 0 : _a2.path) === "/" ? linkFile.path : relative(file.path, linkFile.path);
        if (linkPath === newLinkPath) {
          var bCheck = false;
          const titleIndices = findBracketIndicesOfTitle(original);
          if (titleIndices && 2 < titleIndices.closeIndex - titleIndices.openIndex) {
            const altText = original.substring(titleIndices.openIndex, titleIndices.closeIndex);
            if (altText.includes("/"))
              bCheck = true;
          }
          const linkIndices = findParenthesisIndicesOfURL(original);
          if (linkIndices) {
            const url = original.substring(linkIndices.openIndex, linkIndices.closeIndex);
            if (url.includes(".."))
              bCheck = true;
          }
          if (!bCheck)
            return null;
        }
        const newOriginal = replaceOriginal(root.getBasePath() + "/" + file.path, original, linkPath, newLinkPath);
        if (linkPath === newLinkPath) {
          return null;
        }
        return [original, newOriginal];
      }).filter((pair) => pair);
      if (!(replacePairs == null ? void 0 : replacePairs.length)) {
        return 0;
      }
      try {
        const content = await vault.read(file);
        const replacedContent = replacePairs.reduce((tmpContent, pair) => {
          return (pair == null ? void 0 : pair.length) === 2 ? tmpContent.replace(pair[0], pair[1]) : tmpContent;
        }, content);
        await vault.modify(file, replacedContent);
        const msg = `Update ${replacePairs.length} links in ${file.path}.`;
        console.log(msg);
        if (notice) {
          new import_obsidian.Notice(msg);
        }
        return replacePairs.length;
      } catch (e) {
        console.error(e);
        if (notice) {
          new import_obsidian.Notice("Update links error, see console.");
        }
        throw e;
      }
    }
    function findBracketIndicesOfTitle(original) {
      const openIndex = original.indexOf("[");
      if (openIndex === -1)
        return null;
      const closeIndex = original.indexOf("](", openIndex + 1);
      if (closeIndex === -1)
        return null;
      return { openIndex, closeIndex };
    }
    function findParenthesisIndicesOfURL(str) {
      const openIndex = str.indexOf("(");
      if (openIndex === -1)
        return null;
      const closeIndex = str.indexOf(")", openIndex + 1);
      if (closeIndex === -1)
        return null;
      return { openIndex, closeIndex };
    }
    function getFileName(path) {
      const segments = path.split("/");
      return decodeURIComponent(segments.pop() || "");
    }
    function getFullDirectory(path) {
      const parts = path.split("/");
      parts.pop();
      return parts.join("/");
    }
    function getLastDirectory(path) {
      const parts = path.split("/");
      return parts.length >= 2 ? parts[parts.length - 2] : "";
    }
    function ensureDirSync(dirPath) {
      const fs2 = require("fs");
      if (!fs2.existsSync(dirPath)) {
        fs2.mkdirSync(dirPath, { recursive: true });
      }
    }
    async function copyFileAsync(src, dest) {
      try {
        await import_fs.promises.access(src);
        try {
          await import_fs.promises.copyFile(src, dest);
        } catch (copyErr) {
          new import_obsidian.Notice("-2 \uBCF5\uC0AC \uC2E4\uD328");
          console.error(copyErr);
        }
      } catch (err) {
        new import_obsidian.Notice("-1 \uC6D0\uBCF8 \uC5C6\uC74C");
        console.error(err);
      }
    }
    function replaceOriginal(filePath, original, link, newLink) {
      const titleIndices = findBracketIndicesOfTitle(original);
      if (titleIndices && 2 < titleIndices.closeIndex - titleIndices.openIndex) {
        const tmplinkIndices = findParenthesisIndicesOfURL(original);
        const url = original.substring(tmplinkIndices.openIndex + 1, tmplinkIndices.closeIndex);
        if (url.includes(".md")) {
          const Title = original.substring(titleIndices.openIndex + 1, titleIndices.closeIndex);
          original = original.replace(Title, getFileName(Title));
        } else {
          const Title = original.substring(0, titleIndices.closeIndex);
          if (Title.includes("![")) {
            const Title2 = original.substring(titleIndices.openIndex + 1, titleIndices.closeIndex);
            original = original.replace(Title2, getFileName(link));
          } else {
            original = original.replace(Title, getFileName(link));
          }
        }
      } else {
        original = original.replace("[]", "[" + link + "]");
      }
      const linkIndices = findParenthesisIndicesOfURL(original);
      if (linkIndices) {
        const url = original.substring(linkIndices.openIndex + 1, linkIndices.closeIndex);
        if (url.includes("..") && !url.includes(".md")) {
          const fileDir = getFullDirectory(filePath);
          const newUrlDir = fileDir + "/" + getLastDirectory(link);
          ensureDirSync(newUrlDir);
          copyFileAsync(fileDir + "/" + link, newUrlDir + "/" + getFileName(link));
          newLink = getLastDirectory(link) + "/" + getFileName(link);
        }
        let newOriginal = replaceWithFormat(original, "(" + url + ")", "(" + newLink + ")", (s) => s.replace(/ /g, "%20"));
        if (original === newOriginal) {
          newOriginal = replaceWithFormat(original, "(" + url + ")", "(" + newLink + ")", encodeURI);
        }
        if (original === newOriginal) {
          newOriginal = original.replace(/^(!?\[.*?\]).*$/, `$1(${encodeURI(newLink)})`);
        }
        return newOriginal;
      }
      return null;
    }
    function replaceWithFormat(str, from, to, format) {
      return str.replace(format(from), format(to));
    }
  }
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsibWFpbi50cyIsICJsaWIvcGF0aC50cyJdLAogICJzb3VyY2VzQ29udGVudCI6IFsiaW1wb3J0IHsgQXBwLCBNb2RhbCwgTm90aWNlLCBQbHVnaW4sIFNldHRpbmcsIFRGaWxlLCBGaWxlU3lzdGVtQWRhcHRlciB9IGZyb20gJ29ic2lkaWFuJztcclxuaW1wb3J0IHsgZGlybmFtZSwgcmVsYXRpdmUgfSBmcm9tICcuL2xpYi9wYXRoJztcclxuaW1wb3J0IHsgcHJvbWlzZXMgYXMgZnMgfSBmcm9tICdmcyc7XHJcblxyXG5jbGFzcyBDb25maXJtTW9kYWwgZXh0ZW5kcyBNb2RhbCB7XHJcbiAgICBjb250ZW50OiBzdHJpbmc7XHJcbiAgICBvbkNvbmZpcm06ICgpID0+IHZvaWQ7XHJcblxyXG4gICAgY29uc3RydWN0b3IoYXBwOiBBcHAsIGNvbnRlbnQ6IHN0cmluZywgb25Db25maXJtOiAoKSA9PiB2b2lkKSB7XHJcbiAgICAgICAgc3VwZXIoYXBwKTtcclxuXHJcbiAgICAgICAgdGhpcy5jb250ZW50ID0gY29udGVudDtcclxuICAgICAgICB0aGlzLm9uQ29uZmlybSA9IG9uQ29uZmlybTtcclxuICAgIH1cclxuXHJcbiAgICBvbk9wZW4oKSB7XHJcbiAgICAgICAgY29uc3QgeyBjb250ZW50RWwgfSA9IHRoaXM7XHJcblxyXG4gICAgICAgIGNvbnRlbnRFbC5jcmVhdGVFbCgnaDEnLCB7IHRleHQ6ICdVcGRhdGUgUmVsZWF0ZSBMaW5rcyBQbHVnaW4nIH0pO1xyXG4gICAgICAgIGNvbnRlbnRFbC5jcmVhdGVFbCgncCcsIHsgdGV4dDogdGhpcy5jb250ZW50IH0pO1xyXG5cclxuICAgICAgICBuZXcgU2V0dGluZyhjb250ZW50RWwpXHJcbiAgICAgICAgICAgIC5hZGRCdXR0b24oKGJ0bikgPT4gYnRuXHJcbiAgICAgICAgICAgICAgICAuc2V0QnV0dG9uVGV4dCgnWWVzJylcclxuICAgICAgICAgICAgICAgIC5zZXRDdGEoKVxyXG4gICAgICAgICAgICAgICAgLm9uQ2xpY2soKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY2xvc2UoKTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLm9uQ29uZmlybSgpO1xyXG4gICAgICAgICAgICAgICAgfSkpXHJcbiAgICAgICAgICAgIC5hZGRCdXR0b24oKGJ0bikgPT4gYnRuXHJcbiAgICAgICAgICAgICAgICAuc2V0QnV0dG9uVGV4dCgnTm8nKVxyXG4gICAgICAgICAgICAgICAgLm9uQ2xpY2soKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY2xvc2UoKTtcclxuICAgICAgICAgICAgICAgIH0pKTtcclxuICAgIH1cclxuXHJcbiAgICBvbkNsb3NlKCkge1xyXG4gICAgICAgIHRoaXMuY29udGVudEVsLmVtcHR5KCk7XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFVwZGF0ZVJlbGF0aXZlTGlua3NQbHVnaW4gZXh0ZW5kcyBQbHVnaW4ge1xyXG4gICAgYXN5bmMgb25sb2FkKCkge1xyXG4gICAgICAgIGNvbnN0IHsgYXBwIH0gPSB0aGlzO1xyXG4gICAgICAgIGNvbnN0IHsgbWV0YWRhdGFDYWNoZSwgdmF1bHQgfSA9IGFwcDtcclxuXHJcbiAgICAgICAgY29uc3QgbWVzc2FnZSA9ICdbUmVuZXdlcl0gVGhpcyBjb21tYW5kIHdpbGwgbW9kaWZ5IGFsbCBsaW5rcyBpbiB0aGUgZW50aXJlIHZhdWx0IChub3QganVzdCB0aGUgY3VycmVudCBmaWxlKSB0byByZWxhdGl2ZSBwYXRocywnXHJcbiAgICAgICAgICAgICsgJyBhbmQgdGhpcyBhY3Rpb24gY2Fubm90IGJlIHVuZG9uZS4nXHJcbiAgICAgICAgICAgICsgJyBJdCBpcyByZWNvbW1lbmRlZCB0aGF0IHlvdSBiYWNrIHVwIHRoZSB2YXVsdCBpbiBhZHZhbmNlLidcclxuICAgICAgICAgICAgKyAnIFBsZWFzZSBjb25maXJtIHdoZXRoZXIgeW91IHdhbnQgdG8gZXhlY3V0ZSB0aGUgY29tbWFuZC4nO1xyXG5cclxuICAgICAgICB0aGlzLmFkZENvbW1hbmQoe1xyXG4gICAgICAgICAgICBpZDogJ3VwZGF0ZS1hbGwtcmVsYXRpdmUtbGlua3MgUmVuZXdlcicsXHJcbiAgICAgICAgICAgIG5hbWU6ICdVcGRhdGUgYWxsIHJlbGF0aXZlIGxpbmtzIFJlbmV3ZXInLFxyXG4gICAgICAgICAgICBjYWxsYmFjaygpIHtcclxuICAgICAgICAgICAgICAgIG5ldyBDb25maXJtTW9kYWwoYXBwLCBtZXNzYWdlLCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcHJvbWlzZXMgPSB2YXVsdC5nZXRNYXJrZG93bkZpbGVzKCkubWFwKGZpbGUgPT4gcmVwbGFjZSh2YXVsdC5hZGFwdGVyIGFzIEZpbGVTeXN0ZW1BZGFwdGVyLCBmaWxlLCBmYWxzZSkpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBQcm9taXNlLmFsbChwcm9taXNlcykudGhlbihsaW5rQ291bnRzID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdXBkYXRlZExpbmtDb3VudHMgPSBsaW5rQ291bnRzLmZpbHRlcihjb3VudCA9PiBjb3VudCA+IDApO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbGlua0NvdW50ID0gdXBkYXRlZExpbmtDb3VudHMucmVkdWNlKChzdW0sIGNvdW50KSA9PiBzdW0gKyBjb3VudCwgMCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGZpbGVDb3VudCA9IHVwZGF0ZWRMaW5rQ291bnRzLmxlbmd0aDtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ldyBOb3RpY2UoYFVwZGF0ZSAke2xpbmtDb3VudH0gbGlua3MgaW4gJHtmaWxlQ291bnR9IGZpbGUke2ZpbGVDb3VudCA+IDEgPyAncycgOiAnJ30uYCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSkuY2F0Y2goZXJyID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbmV3IE5vdGljZSgnVXBkYXRlIGxpbmtzIGVycm9yLCBzZWUgY29uc29sZS4nKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnIpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfSkub3BlbigpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHRoaXMucmVnaXN0ZXJFdmVudCh2YXVsdC5vbigncmVuYW1lJywgKGZpbGUsIG9sZFBhdGgpID0+IHtcclxuICAgICAgICAgICAgaWYgKCFvbGRQYXRoXHJcbiAgICAgICAgICAgICAgICB8fCAhZmlsZS5wYXRoLnRvTG9jYWxlTG93ZXJDYXNlKCkuZW5kc1dpdGgoJy5tZCcpXHJcbiAgICAgICAgICAgICAgICB8fCBmaWxlLnBhcmVudD8ucGF0aCA9PT0gZGlybmFtZShvbGRQYXRoKSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAoZmlsZSBpbnN0YW5jZW9mIFRGaWxlKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBhZGFwdGVyID0gYXBwLnZhdWx0LmFkYXB0ZXI7XHJcbiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHJlcGxhY2UodmF1bHQuYWRhcHRlciBhcyBGaWxlU3lzdGVtQWRhcHRlciwgZmlsZSwgdHJ1ZSksIDEwMCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KSk7XHJcblxyXG4gICAgICAgIGFzeW5jIGZ1bmN0aW9uIHJlcGxhY2Uocm9vdDogRmlsZVN5c3RlbUFkYXB0ZXIsIGZpbGU6IFRGaWxlLCBub3RpY2U6IGJvb2xlYW4pIHtcclxuICAgICAgICAgICAgY29uc3QgbWV0YWRhdGEgPSBtZXRhZGF0YUNhY2hlLmdldEZpbGVDYWNoZShmaWxlKTtcclxuICAgICAgICAgICAgY29uc3QgbGlua3MgPSBbLi4uKG1ldGFkYXRhPy5saW5rcyA/PyBbXSksIC4uLihtZXRhZGF0YT8uZW1iZWRzID8/IFtdKV07XHJcbiAgICAgICAgICAgIGNvbnN0IHJlcGxhY2VQYWlycyA9IGxpbmtzLm1hcCgoeyBsaW5rLCBvcmlnaW5hbCB9KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAvL2lmICghb3JpZ2luYWwuc3RhcnRzV2l0aCgnIVsnKSkgcmV0dXJuIG51bGw7XHJcblxyXG4gICAgICAgICAgICAgICAgY29uc3QgbGlua1BhdGggPSBsaW5rLnJlcGxhY2UoLyMuKiQvLCAnJyk7XHJcbiAgICAgICAgICAgICAgICBpZiAoIWxpbmtQYXRoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgY29uc3QgbGlua0ZpbGUgPSBtZXRhZGF0YUNhY2hlLmdldEZpcnN0TGlua3BhdGhEZXN0KGxpbmtQYXRoLCBmaWxlLnBhdGgpO1xyXG4gICAgICAgICAgICAgICAgaWYgKCFsaW5rRmlsZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGNvbnN0IG5ld0xpbmtQYXRoID0gZmlsZS5wYXJlbnQ/LnBhdGggPT09ICcvJyA/IGxpbmtGaWxlLnBhdGggOiByZWxhdGl2ZShmaWxlLnBhdGgsIGxpbmtGaWxlLnBhdGgpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGxpbmtQYXRoID09PSBuZXdMaW5rUGF0aCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBiQ2hlY2sgPSBmYWxzZTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdGl0bGVJbmRpY2VzID0gZmluZEJyYWNrZXRJbmRpY2VzT2ZUaXRsZShvcmlnaW5hbClcclxuICAgICAgICAgICAgICAgICAgICBpZih0aXRsZUluZGljZXMgJiYgMiA8ICh0aXRsZUluZGljZXMuY2xvc2VJbmRleCAtIHRpdGxlSW5kaWNlcy5vcGVuSW5kZXgpKVxyXG4gICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYWx0VGV4dCA9IG9yaWdpbmFsLnN1YnN0cmluZyh0aXRsZUluZGljZXMub3BlbkluZGV4ICwgdGl0bGVJbmRpY2VzLmNsb3NlSW5kZXgpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKGFsdFRleHQuaW5jbHVkZXMoJy8nKSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJDaGVjayA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBsaW5rSW5kaWNlcyA9IGZpbmRQYXJlbnRoZXNpc0luZGljZXNPZlVSTChvcmlnaW5hbClcclxuICAgICAgICAgICAgICAgICAgICBpZihsaW5rSW5kaWNlcylcclxuICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHVybCA9IG9yaWdpbmFsLnN1YnN0cmluZyhsaW5rSW5kaWNlcy5vcGVuSW5kZXggLCBsaW5rSW5kaWNlcy5jbG9zZUluZGV4KVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZih1cmwuaW5jbHVkZXMoJy4uJykpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiQ2hlY2sgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYoIWJDaGVjaylcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgY29uc3QgbmV3T3JpZ2luYWwgPSByZXBsYWNlT3JpZ2luYWwocm9vdC5nZXRCYXNlUGF0aCgpICsgXCIvXCIgKyBmaWxlLnBhdGgsIG9yaWdpbmFsLCBsaW5rUGF0aCwgbmV3TGlua1BhdGgpO1xyXG4gICAgICAgICAgICAgICAgLy9uZXcgTm90aWNlKCdvcmlnaW5hbDogJyArIG9yaWdpbmFsICsgJ1xcbm5ld09yaWdpbmFsOiAnICsgbmV3T3JpZ2luYWwpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGxpbmtQYXRoID09PSBuZXdMaW5rUGF0aCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIFtvcmlnaW5hbCwgbmV3T3JpZ2luYWxdO1xyXG4gICAgICAgICAgICB9KS5maWx0ZXIocGFpciA9PiBwYWlyKTtcclxuXHJcbiAgICAgICAgICAgIGlmICghcmVwbGFjZVBhaXJzPy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiAwO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgY29udGVudCA9IGF3YWl0IHZhdWx0LnJlYWQoZmlsZSk7XHJcblxyXG4gICAgICAgICAgICAgICAgY29uc3QgcmVwbGFjZWRDb250ZW50ID0gcmVwbGFjZVBhaXJzLnJlZHVjZSgodG1wQ29udGVudCwgcGFpcikgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBwYWlyPy5sZW5ndGggPT09IDIgXHJcbiAgICAgICAgICAgICAgICAgICAgPyB0bXBDb250ZW50LnJlcGxhY2UocGFpclswXSwgcGFpclsxXSkgXHJcbiAgICAgICAgICAgICAgICAgICAgOiB0bXBDb250ZW50O1xyXG4gICAgICAgICAgICAgICAgfSwgY29udGVudCk7XHJcblxyXG4gICAgICAgICAgICAgICAgYXdhaXQgdmF1bHQubW9kaWZ5KGZpbGUsIHJlcGxhY2VkQ29udGVudCk7XHJcblxyXG4gICAgICAgICAgICAgICAgY29uc3QgbXNnID0gYFVwZGF0ZSAke3JlcGxhY2VQYWlycy5sZW5ndGh9IGxpbmtzIGluICR7ZmlsZS5wYXRofS5gO1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2cobXNnKTtcclxuICAgICAgICAgICAgICAgIGlmIChub3RpY2UpIHtcclxuICAgICAgICAgICAgICAgICAgICBuZXcgTm90aWNlKG1zZyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVwbGFjZVBhaXJzLmxlbmd0aDtcclxuICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlKTtcclxuICAgICAgICAgICAgICAgIGlmIChub3RpY2UpIHtcclxuICAgICAgICAgICAgICAgICAgICBuZXcgTm90aWNlKCdVcGRhdGUgbGlua3MgZXJyb3IsIHNlZSBjb25zb2xlLicpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgdGhyb3cgZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgZnVuY3Rpb24gZmluZEJyYWNrZXRJbmRpY2VzT2ZUaXRsZShvcmlnaW5hbDogc3RyaW5nKTogeyBvcGVuSW5kZXg6IG51bWJlcjsgY2xvc2VJbmRleDogbnVtYmVyIH0gfCBudWxsIHtcclxuICAgICAgICAgICAgY29uc3Qgb3BlbkluZGV4ID0gb3JpZ2luYWwuaW5kZXhPZignWycpXHJcbiAgICAgICAgICAgIGlmIChvcGVuSW5kZXggPT09IC0xKSByZXR1cm4gbnVsbFxyXG4gICAgICAgICAgICBjb25zdCBjbG9zZUluZGV4ID0gb3JpZ2luYWwuaW5kZXhPZignXSgnLCBvcGVuSW5kZXggKyAxKVxyXG4gICAgICAgICAgICBpZiAoY2xvc2VJbmRleCA9PT0gLTEpIHJldHVybiBudWxsXHJcbiAgICAgICAgICAgIHJldHVybiB7IG9wZW5JbmRleCwgY2xvc2VJbmRleCB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBmdW5jdGlvbiBmaW5kUGFyZW50aGVzaXNJbmRpY2VzT2ZVUkwoc3RyOiBzdHJpbmcpOiB7IG9wZW5JbmRleDogbnVtYmVyOyBjbG9zZUluZGV4OiBudW1iZXIgfSB8IG51bGwge1xyXG4gICAgICAgICAgICBjb25zdCBvcGVuSW5kZXggPSBzdHIuaW5kZXhPZignKCcpXHJcbiAgICAgICAgICAgIGlmIChvcGVuSW5kZXggPT09IC0xKSByZXR1cm4gbnVsbFxyXG4gICAgICAgICAgICBjb25zdCBjbG9zZUluZGV4ID0gc3RyLmluZGV4T2YoJyknLCBvcGVuSW5kZXggKyAxKVxyXG4gICAgICAgICAgICBpZiAoY2xvc2VJbmRleCA9PT0gLTEpIHJldHVybiBudWxsXHJcbiAgICAgICAgICAgIHJldHVybiB7IG9wZW5JbmRleCwgY2xvc2VJbmRleCB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBmdW5jdGlvbiBnZXRGaWxlTmFtZShwYXRoOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgICAgICAgICBjb25zdCBzZWdtZW50cyA9IHBhdGguc3BsaXQoJy8nKTtcclxuICAgICAgICAgICAgcmV0dXJuIGRlY29kZVVSSUNvbXBvbmVudChzZWdtZW50cy5wb3AoKSB8fCAnJyk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBmdW5jdGlvbiBnZXRGdWxsRGlyZWN0b3J5KHBhdGg6IHN0cmluZykge1xyXG4gICAgICAgICAgICBjb25zdCBwYXJ0cyA9IHBhdGguc3BsaXQoJy8nKTtcclxuICAgICAgICAgICAgcGFydHMucG9wKCk7ICAgICAgICAgICAgICAgIC8vIFx1QjlDOFx1QzlDMFx1QjlDOSBcdUM2OTRcdUMxOEMoXHVEMzBDXHVDNzdDXHVCQTg1KSBcdUM4MUNcdUFDNzBcclxuICAgICAgICAgICAgcmV0dXJuIHBhcnRzLmpvaW4oJy8nKTsgICAgIC8vIFx1QjA5OFx1QkEzOFx1QzlDMCBcdUM2OTRcdUMxOENcdUI5N0MgJy8nXHVCODVDIFx1QUNCMFx1RDU2OVxyXG4gICAgICAgIH1cclxuICAgICAgICBmdW5jdGlvbiBnZXRMYXN0RGlyZWN0b3J5KHBhdGg6IHN0cmluZykge1xyXG4gICAgICAgICAgICBjb25zdCBwYXJ0cyA9IHBhdGguc3BsaXQoJy8nKTtcclxuICAgICAgICAgICAgLy8gXHVEMzBDXHVDNzdDXHVCQTg1XHVDNzc0IFx1QzU0NFx1QjJDQyBcdUI5QzhcdUM5QzBcdUI5QzkgXHVEM0Y0XHVCMzU0IFx1Qzc3OFx1QjM3MVx1QzJBNFx1QjI5NCBsZW5ndGgtMlxyXG4gICAgICAgICAgICByZXR1cm4gcGFydHMubGVuZ3RoID49IDIgPyBwYXJ0c1twYXJ0cy5sZW5ndGggLSAyXSA6ICcnO1xyXG4gICAgICAgIH1cclxuICAgICAgICBmdW5jdGlvbiBlbnN1cmVEaXJTeW5jKGRpclBhdGg6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgICAgICAgICAvL25ldyBOb3RpY2UoJ2Vuc3VyZURpclN5bmM6ICcgKyBkaXJQYXRoKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGNvbnN0IGZzID0gcmVxdWlyZSgnZnMnKTtcclxuICAgICAgICAgICAgaWYgKCFmcy5leGlzdHNTeW5jKGRpclBhdGgpKSB7XHJcbiAgICAgICAgICAgICAgICAvL25ldyBOb3RpY2UoJ1x1QzBERFx1QzEzMVx1RDU2OVx1QjJDOFx1QjJFNC4nKTtcclxuICAgICAgICAgICAgICAgIGZzLm1rZGlyU3luYyhkaXJQYXRoLCB7IHJlY3Vyc2l2ZTogdHJ1ZSB9KTtcclxuICAgICAgICAgICAgICAgIC8vbmV3IE5vdGljZSgnXHVDMEREXHVDMTMxIFx1QzY0NFx1QjhDQy4nKTtcclxuICAgICAgICAgICAgICAgIC8vaWYgKGZzLmV4aXN0c1N5bmMoZGlyUGF0aCkpIHtcclxuICAgICAgICAgICAgICAgIC8vICAgIG5ldyBOb3RpY2UoJ1x1Qzg3NFx1QzdBQ1x1RDU2OVx1QjJDOFx1QjJFNCcpO1xyXG4gICAgICAgICAgICAgICAgLy99XHJcbiAgICAgICAgICAgICAgICAvL2Vsc2V7XHJcbiAgICAgICAgICAgICAgICAvLyAgICBuZXcgTm90aWNlKCdcdUMwRERcdUMxMzEgXHVDMkU0XHVEMzI4LicpO1xyXG4gICAgICAgICAgICAgICAgLy99XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgLy9lbHNle1xyXG4gICAgICAgICAgICAvLyAgICBuZXcgTm90aWNlKCdcdUM4NzRcdUM3QUNcdUQ1NjlcdUIyQzhcdUIyRTQuJyk7XHJcbiAgICAgICAgICAgIC8vfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgYXN5bmMgZnVuY3Rpb24gY29weUZpbGVBc3luYyhzcmM6IHN0cmluZywgZGVzdDogc3RyaW5nKSB7XHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICBhd2FpdCBmcy5hY2Nlc3Moc3JjKTsgIC8vIFx1QzZEMFx1QkNGOCBcdUQzMENcdUM3N0MgXHVDODExXHVBREZDIFx1RDY1NVx1Qzc3OFxyXG4gICAgICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgICAgICBhd2FpdCBmcy5jb3B5RmlsZShzcmMsIGRlc3QpOyAgLy8gXHUyNzA1IFx1QzYyQ1x1QkMxNFx1Qjk3OCBcdUJDRjVcdUMwQUMgXHVCQzI5XHVDMkREXHJcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChjb3B5RXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbmV3IE5vdGljZSgnLTIgXHVCQ0Y1XHVDMEFDIFx1QzJFNFx1RDMyOCcpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoY29weUVycik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgXHJcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICAgICAgICAgICAgbmV3IE5vdGljZSgnLTEgXHVDNkQwXHVCQ0Y4IFx1QzVDNlx1Qzc0QycpO1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnIpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBmdW5jdGlvbiByZXBsYWNlT3JpZ2luYWwoZmlsZVBhdGg6IHN0cmluZywgb3JpZ2luYWw6IHN0cmluZywgbGluazogc3RyaW5nLCBuZXdMaW5rOiBzdHJpbmcpIHtcclxuICAgICAgICAgICAgLy9uZXcgTm90aWNlKCdvcmlnaW5hbDogJyArIG9yaWdpbmFsKTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IHRpdGxlSW5kaWNlcyA9IGZpbmRCcmFja2V0SW5kaWNlc09mVGl0bGUob3JpZ2luYWwpXHJcbiAgICAgICAgICAgIGlmKHRpdGxlSW5kaWNlcyAmJiAyIDwgKHRpdGxlSW5kaWNlcy5jbG9zZUluZGV4IC0gdGl0bGVJbmRpY2VzLm9wZW5JbmRleCkpXHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHRtcGxpbmtJbmRpY2VzID0gZmluZFBhcmVudGhlc2lzSW5kaWNlc09mVVJMKG9yaWdpbmFsKVxyXG4gICAgICAgICAgICAgICAgY29uc3QgdXJsID0gb3JpZ2luYWwuc3Vic3RyaW5nKHRtcGxpbmtJbmRpY2VzLm9wZW5JbmRleCArIDEsIHRtcGxpbmtJbmRpY2VzLmNsb3NlSW5kZXgpXHJcbiAgICAgICAgICAgICAgICBpZih1cmwuaW5jbHVkZXMoJy5tZCcpKXtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBUaXRsZSA9IG9yaWdpbmFsLnN1YnN0cmluZyh0aXRsZUluZGljZXMub3BlbkluZGV4ICsgMSAsIHRpdGxlSW5kaWNlcy5jbG9zZUluZGV4KVxyXG4gICAgICAgICAgICAgICAgICAgIC8vbmV3IE5vdGljZSgnVGl0bGUxOiAnICsgVGl0bGUpO1xyXG4gICAgICAgICAgICAgICAgICAgIG9yaWdpbmFsID0gb3JpZ2luYWwucmVwbGFjZShUaXRsZSwgZ2V0RmlsZU5hbWUoVGl0bGUpKTtcclxuICAgICAgICAgICAgICAgICAgICAvL25ldyBOb3RpY2UoJ1RpdGxlMSBSZXN1bHQ6ICcgKyBvcmlnaW5hbCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNle1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IFRpdGxlID0gb3JpZ2luYWwuc3Vic3RyaW5nKDAgLCB0aXRsZUluZGljZXMuY2xvc2VJbmRleClcclxuICAgICAgICAgICAgICAgICAgICBpZihUaXRsZS5pbmNsdWRlcyhcIiFbXCIpKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgVGl0bGUgPSBvcmlnaW5hbC5zdWJzdHJpbmcodGl0bGVJbmRpY2VzLm9wZW5JbmRleCArIDEgLCB0aXRsZUluZGljZXMuY2xvc2VJbmRleClcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy9uZXcgTm90aWNlKCdUaXRsZTE6ICcgKyBUaXRsZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG9yaWdpbmFsID0gb3JpZ2luYWwucmVwbGFjZShUaXRsZSwgZ2V0RmlsZU5hbWUobGluaykpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvL25ldyBOb3RpY2UoJ1RpdGxlMSBSZXN1bHQ6ICcgKyBvcmlnaW5hbCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2V7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vbmV3IE5vdGljZSgnVGl0bGUyOiAnICsgVGl0bGUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBvcmlnaW5hbCA9IG9yaWdpbmFsLnJlcGxhY2UoVGl0bGUsIGdldEZpbGVOYW1lKGxpbmspKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy9uZXcgTm90aWNlKCdUaXRsZTIgUmVzdWx0OiAnICsgb3JpZ2luYWwpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlXHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgIC8vbmV3IE5vdGljZSgnVGl0bGUzOiAnICsgb3JpZ2luYWwpO1xyXG4gICAgICAgICAgICAgICAgb3JpZ2luYWwgPSBvcmlnaW5hbC5yZXBsYWNlKFwiW11cIiwgXCJbXCIrbGluaytcIl1cIik7XHJcbiAgICAgICAgICAgICAgICAvL25ldyBOb3RpY2UoJ1RpdGxlMyBSZXN1bHQ6ICcgKyBvcmlnaW5hbCk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGNvbnN0IGxpbmtJbmRpY2VzID0gZmluZFBhcmVudGhlc2lzSW5kaWNlc09mVVJMKG9yaWdpbmFsKVxyXG4gICAgICAgICAgICBpZihsaW5rSW5kaWNlcylcclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgdXJsID0gb3JpZ2luYWwuc3Vic3RyaW5nKGxpbmtJbmRpY2VzLm9wZW5JbmRleCArIDEsIGxpbmtJbmRpY2VzLmNsb3NlSW5kZXgpXHJcbiAgICAgICAgICAgICAgICBpZih1cmwuaW5jbHVkZXMoJy4uJykgJiYgIXVybC5pbmNsdWRlcygnLm1kJykpXHJcbiAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZmlsZURpciA9IGdldEZ1bGxEaXJlY3RvcnkoZmlsZVBhdGgpO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vbmV3IE5vdGljZSgnZmlsZURpcjogJyArIGZpbGVEaXIpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG5ld1VybERpciA9IGZpbGVEaXIgKyBcIi9cIiArIGdldExhc3REaXJlY3RvcnkobGluayk7XHJcbiAgICAgICAgICAgICAgICAgICAgLy9uZXcgTm90aWNlKCduZXdVcmxEaXI6ICcgKyBuZXdVcmxEaXIpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBlbnN1cmVEaXJTeW5jKG5ld1VybERpcilcclxuICAgICAgICAgICAgICAgICAgICBjb3B5RmlsZUFzeW5jKGZpbGVEaXIrXCIvXCIrbGluaywgbmV3VXJsRGlyK1wiL1wiK2dldEZpbGVOYW1lKGxpbmspKVxyXG4gICAgICAgICAgICAgICAgICAgIG5ld0xpbmsgPSBnZXRMYXN0RGlyZWN0b3J5KGxpbmspICsgXCIvXCIgKyBnZXRGaWxlTmFtZShsaW5rKTtcclxuICAgICAgICAgICAgICAgICAgICAvL25ldyBOb3RpY2UoJ3JlcGxhY2VPcmlnaW5hbCcpO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vbmV3IE5vdGljZSgnZmlsZURpcjogJyArIGZpbGVEaXIpO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vbmV3IE5vdGljZSgnZmlsZVBhdGg6ICcgKyBmaWxlUGF0aCk7XHJcbiAgICAgICAgICAgICAgICAgICAgLy9uZXcgTm90aWNlKCdvcmlnaW5hbDogJyArIG9yaWdpbmFsKTtcclxuICAgICAgICAgICAgICAgICAgICAvL25ldyBOb3RpY2UoJ2xpbms6ICcgKyBsaW5rKTtcclxuICAgICAgICAgICAgICAgICAgICAvL25ldyBOb3RpY2UoJ25ld0xpbms6ICcgKyBuZXdMaW5rKTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBsZXQgbmV3T3JpZ2luYWwgPSByZXBsYWNlV2l0aEZvcm1hdChvcmlnaW5hbCwgXCIoXCIrdXJsK1wiKVwiLCBcIihcIituZXdMaW5rK1wiKVwiLCBzID0+IHMucmVwbGFjZSgvIC9nLCAnJTIwJykpO1xyXG4gICAgICAgICAgICAgICAgaWYgKG9yaWdpbmFsID09PSBuZXdPcmlnaW5hbCkge1xyXG4gICAgICAgICAgICAgICAgICAgIG5ld09yaWdpbmFsID0gcmVwbGFjZVdpdGhGb3JtYXQob3JpZ2luYWwsIFwiKFwiK3VybCtcIilcIiwgXCIoXCIrbmV3TGluaytcIilcIiwgZW5jb2RlVVJJKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmIChvcmlnaW5hbCA9PT0gbmV3T3JpZ2luYWwpIHtcclxuICAgICAgICAgICAgICAgICAgICBuZXdPcmlnaW5hbCA9IG9yaWdpbmFsLnJlcGxhY2UoL14oIT9cXFsuKj9cXF0pLiokLywgYCQxKCR7ZW5jb2RlVVJJKG5ld0xpbmspfSlgKVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgLy9uZXcgTm90aWNlKCduZXdPcmlnaW5hbDogJyArIG5ld09yaWdpbmFsKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBuZXdPcmlnaW5hbDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGZ1bmN0aW9uIHJlcGxhY2VXaXRoRm9ybWF0KHN0cjogc3RyaW5nLCBmcm9tOiBzdHJpbmcsIHRvOiBzdHJpbmcsIGZvcm1hdDogKHM6IHN0cmluZykgPT4gc3RyaW5nKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBzdHIucmVwbGFjZShmb3JtYXQoZnJvbSksIGZvcm1hdCh0bykpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG4iLCAiY29uc3QgU0VQID0gJy8nO1xyXG5cclxuZnVuY3Rpb24gZGlybmFtZShwYXRoOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgcmV0dXJuIHN0YWNrVG9QYXRoKHBhdGhUb1N0YWNrKHBhdGgpLnNsaWNlKDAsIC0xKSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHJlbGF0aXZlKGZyb206IHN0cmluZywgdG86IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICBpZiAoIWZyb20pIHtcclxuICAgICAgICByZXR1cm4gdG87XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgZnJvbVN0YWNrID0gcGF0aFRvU3RhY2soZnJvbSk7XHJcbiAgICBjb25zdCB0b1N0YWNrID0gcGF0aFRvU3RhY2sodG8pO1xyXG5cclxuICAgIGNvbnN0IGZpcnN0RGlmZklkeCA9IGZyb21TdGFjay5maW5kSW5kZXgoKHZhbHVlLCBpZHgpID0+IHZhbHVlICE9IHRvU3RhY2tbaWR4XSk7XHJcblxyXG4gICAgY29uc3QgcmVzdWx0U3RhY2s6IHN0cmluZ1tdID0gW107XHJcblxyXG4gICAgZm9yIChsZXQgaSA9IGZpcnN0RGlmZklkeDsgaSA8IGZyb21TdGFjay5sZW5ndGggLSAxOyBpKyspIHtcclxuICAgICAgICByZXN1bHRTdGFjay5wdXNoKCcuLicpO1xyXG4gICAgfVxyXG5cclxuICAgIGZvciAobGV0IGkgPSBmaXJzdERpZmZJZHg7IGkgPCB0b1N0YWNrLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgcmVzdWx0U3RhY2sucHVzaCh0b1N0YWNrW2ldKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gc3RhY2tUb1BhdGgocmVzdWx0U3RhY2spO1xyXG59XHJcblxyXG5mdW5jdGlvbiBwYXRoVG9TdGFjayhwYXRoOiBzdHJpbmcpOiBzdHJpbmdbXSB7XHJcbiAgICByZXR1cm4gcGF0aC5zcGxpdChTRVApO1xyXG59XHJcblxyXG5mdW5jdGlvbiBzdGFja1RvUGF0aChzdGFjazogc3RyaW5nW10pOiBzdHJpbmcge1xyXG4gICAgcmV0dXJuIHN0YWNrLmpvaW4oU0VQKTtcclxufVxyXG5cclxuZXhwb3J0IHsgZGlybmFtZSwgcmVsYXRpdmUgfVxyXG4iXSwKICAibWFwcGluZ3MiOiAiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUEsc0JBQThFOzs7QUNBOUUsSUFBTSxNQUFNO0FBRVosU0FBUyxRQUFRLE1BQXNCO0FBQ25DLFNBQU8sWUFBWSxZQUFZLElBQUksRUFBRSxNQUFNLEdBQUcsRUFBRSxDQUFDO0FBQ3JEO0FBRUEsU0FBUyxTQUFTLE1BQWMsSUFBb0I7QUFDaEQsTUFBSSxDQUFDLE1BQU07QUFDUCxXQUFPO0FBQUEsRUFDWDtBQUVBLFFBQU0sWUFBWSxZQUFZLElBQUk7QUFDbEMsUUFBTSxVQUFVLFlBQVksRUFBRTtBQUU5QixRQUFNLGVBQWUsVUFBVSxVQUFVLENBQUMsT0FBTyxRQUFRLFNBQVMsUUFBUSxJQUFJO0FBRTlFLFFBQU0sY0FBd0IsQ0FBQztBQUUvQixXQUFTLElBQUksY0FBYyxJQUFJLFVBQVUsU0FBUyxHQUFH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QWlCLDRCQUE0QixRQUFRO0FBQzNELGNBQU0sTUFBTSxTQUFTLFVBQVUsZUFBZSxZQUFZLEdBQUcsZUFBZSxVQUFVO0FBQ3RGLFlBQUcsSUFBSSxTQUFTLEtBQUssR0FBRTtBQUNuQixnQkFBTSxRQUFRLFNBQVMsVUFBVSxhQUFhLFlBQVksR0FBSSxhQUFhLFVBQVU7QUFFckYscUJBQVcsU0FBUyxRQUFRLE9BQU8sWUFBWSxLQUFLLENBQUM7QUFBQSxRQUV6RCxPQUNJO0FBQ0EsZ0JBQU0sUUFBUSxTQUFTLFVBQVUsR0FBSSxhQUFhLFVBQVU7QUFDNUQsY0FBRyxNQUFNLFNBQVMsSUFBSSxHQUFFO0FBQ3BCLGtCQUFNQyxTQUFRLFNBQVMsVUFBVSxhQUFhLFlBQVksR0FBSSxhQUFhLFVBQVU7QUFFckYsdUJBQVcsU0FBUyxRQUFRQSxRQUFPLFlBQVksSUFBSSxDQUFDO0FBQUEsVUFFeEQsT0FDSTtBQUVBLHVCQUFXLFNBQVMsUUFBUSxPQUFPLFlBQVksSUFBSSxDQUFDO0FBQUEsVUFFeEQ7QUFBQSxRQUNKO0FBQUEsTUFDSixPQUVBO0FBRUksbUJBQVcsU0FBUyxRQUFRLE1BQU0sTUFBSSxPQUFLLEdBQUc7QUFBQSxNQUVsRDtBQUVBLFlBQU0sY0FBYyw0QkFBNEIsUUFBUTtBQUN4RCxVQUFHLGFBQ0g7QUFDSSxjQUFNLE1BQU0sU0FBUyxVQUFVLFlBQVksWUFBWSxHQUFHLFlBQVksVUFBVTtBQUNoRixZQUFHLElBQUksU0FBUyxJQUFJLEtBQUssQ0FBQyxJQUFJLFNBQVMsS0FBSyxHQUM1QztBQUNJLGdCQUFNLFVBQVUsaUJBQWlCLFFBQVE7QUFFekMsZ0JBQU0sWUFBWSxVQUFVLE1BQU0saUJBQWlCLElBQUk7QUFHdkQsd0JBQWMsU0FBUztBQUN2Qix3QkFBYyxVQUFRLE1BQUksTUFBTSxZQUFVLE1BQUksWUFBWSxJQUFJLENBQUM7QUFDL0Qsb0JBQVUsaUJBQWlCLElBQUksSUFBSSxNQUFNLFlBQVksSUFBSTtBQUFBLFFBTzdEO0FBRUEsWUFBSSxjQUFjLGtCQUFrQixVQUFVLE1BQUksTUFBSSxLQUFLLE1BQUksVUFBUSxLQUFLLE9BQUssRUFBRSxRQUFRLE1BQU0sS0FBSyxDQUFDO0FBQ3ZHLFlBQUksYUFBYSxhQUFhO0FBQzFCLHdCQUFjLGtCQUFrQixVQUFVLE1BQUksTUFBSSxLQUFLLE1BQUksVUFBUSxLQUFLLFNBQVM7QUFBQSxRQUNyRjtBQUNBLFlBQUksYUFBYSxhQUFhO0FBQzFCLHdCQUFjLFNBQVMsUUFBUSxtQkFBbUIsTUFBTSxVQUFVLE9BQU8sSUFBSTtBQUFBLFFBQ2pGO0FBRUEsZUFBTztBQUFBLE1BQ1g7QUFDQSxhQUFPO0FBQUEsSUFDWDtBQUVBLGFBQVMsa0JBQWtCLEtBQWEsTUFBYyxJQUFZLFFBQStCO0FBQzdGLGFBQU8sSUFBSSxRQUFRLE9BQU8sSUFBSSxHQUFHLE9BQU8sRUFBRSxDQUFDO0FBQUEsSUFDL0M7QUFBQSxFQUNKO0FBQ0o7IiwKICAibmFtZXMiOiBbIl9hIiwgImZzIiwgIlRpdGxlIl0KfQo=
